# linux semaphore（linux 6.10）

信号量（Semaphore）是 Linux 内核中用于实现同步的一种机制，通常用于控制对共享资源的访问。信号量的核心思想是：

- 当信号量的值大于 0 时，表示资源可用，任务可以继续执行。

- 当信号量的值等于 0 时，表示资源不可用，任务需要等待

1. make编译，加载模块insmod semaphore_demo.ko
2. dmesg -w监控输出
4. 卸载模块rmmod semaphore_demo


## 信号量特点

- 睡眠等待：当信号量的值为 0 时，尝试获取信号量的任务会进入睡眠状态，直到信号量可用。

- 适用于长时间等待：适合保护可能长时间持有的资源。

- 可中断：down_interruptible 允许任务在等待信号量时被中断。

- 计数信号量：信号量的值可以大于 1，允许多个任务同时访问资源。


## 适用场景

- 保护可能长时间持有的资源：例如，保护文件系统操作、网络协议栈操作等。

- 需要任务睡眠的场景：例如，等待某个条件满足（如缓冲区非空）。

- 需要可中断的等待：例如，用户空间任务等待内核事件。


## 和自旋锁spinlock的区别

| 特性 | 信号量（Semaphore） | 自旋锁（Spinlock） |
| ------ | ------ | ------ |
| 等待方式 | 睡眠等待 | 忙等待 |
| 适用场景 | 长时间持有的资源 | 短时间持有的资源 |
| 是否可睡眠 | 可以睡眠 | 不可睡眠 |
| 是否可中断 | 可中断（down_interruptible） | 不可中断 |
| 适用上下文 | 进程上下文 | 进程上下文和中断上下文 |
| 性能开销 | 较高（任务切换开销） | 较低（忙等待开销） |
| 计数支持 | 支持计数信号量 | 仅支持二进制锁 |


## 选择信号量还是自旋锁？

### 选择信号量的场景
- 需要保护可能长时间持有的资源。

- 任务可以在等待时睡眠。

- 需要支持多个任务同时访问资源（计数信号量）。

### 选择自旋锁的场景
- 需要保护非常短时间持有的资源。

- 任务不能在等待时睡眠（如中断上下文）。

- 多核环境中需要高效同步。